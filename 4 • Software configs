#!/bin/bash

# ğŸ€ğŸ€ ---------- Create project diectory ---------- ğŸ€ğŸ€

# ğŸ€ This block will write files in /home/bean/bean/, if you aren't using GitHub, use this as your project directory.
# â˜ï¸ If you use GitHub, just clone the repo and use that as the directory.

cd ~
mkdir -p ~/bean/{audio,vision/faces,chat,hardware,utils,service}
touch ~/bean/{audio,vision,chat,hardware,utils}/__init__.py
touch ~/bean/main.py  # â˜ï¸ Root entry point.
touch ~/bean/chat/{memory.txt,chatlogic.py}  # â˜ï¸ Chat.
touch ~/bean/audio/{record.py,tts.py}  # â˜ï¸ Audio.
touch ~/bean/vision/display.py  # â˜ï¸ Display.
touch ~/bean/hardware/button.py  # â˜ï¸ Hardware helpers.
touch ~/bean/utils/{config.py,logger.py}   # â˜ï¸ Generic helpers.
touch ~/bean/service/bean.service  # â˜ï¸ Future systemd service file.
touch ~/bean/audio/stt.py # â˜ï¸ Audio STT.

# ğŸ€ğŸ€ ---------- Save your keys ---------- ğŸ€ğŸ€

# ğŸ€ Create .env file inside the project root.
cd ~
nano .env

# ğŸ€ Inside nano add your keys.
OPENAI_API_KEY="KEY"
ELEVENLABS_API_KEY="KEY"

# ğŸ€ Stop Git from committing the keys lol.
echo -e "\n# Bean secrets\n.env" >> ~/.gitignore_global
git config --global core.excludesfile ~/.gitignore_global

# ğŸ€ Check if your keys are present. Once you run these it should print the first 8 characters of your keys.
python - <<'PY'
from os import getenv
from pathlib import Path
from dotenv import load_dotenv
load_dotenv(Path.home() / "bean" / ".env")
print("OpenAI key starts with:", getenv("OPENAI_API_KEY")[:8])
print("ElevenLabs key starts with:", getenv("ELEVENLABS_API_KEY")[:8])
PY

# ğŸ€ Make keys available to systemd service cos it doesn't read .bashrc.
sudo mkdir -p /etc/systemd/system/bean.service.d  # â˜ï¸ Create a drop-in directory.
sudo nano /etc/systemd/system/bean.service.d/env.conf # â˜ï¸ Add an environment directive.

# ğŸ€ Inside nano add this.
[Service]
EnvironmentFile=/home/bean/.env

# ğŸ€ Reload.
sudo systemctl daemon-reload

# ğŸ€ğŸ€ ---------- Connect to GitHub ---------- ğŸ€ğŸ€

# ğŸ€ Generate SSH keys.
ssh-keygen -t ed25519 -C "me@bean"  # â˜ï¸ Add this to your SSH keys on GitHub.

# ğŸ€ Stop Git from committing the keys.
echo -e '\n# SSH keys\n**/.ssh/\n**/id_*' >> ~/.gitignore_global

# ğŸ€ Clone your repo onto your Pi.
sudo apt update && sudo apt install git
cd ~
git clone git@github.com:USERNAME/REPO.git
cd REPO

# ğŸ€ Set your identify.
git config --global user.email "EMAIL"
git config --global user.name "NAME"

# ğŸ€ğŸ€ ---------- Initalise GitHub repo ---------- ğŸ€ğŸ€

# ğŸ€ Only use this block if the repo you cloned doesn't already have a folder acting as your project directory.

# ğŸ€ Make a dedicated folder in the repo and copy everything except the repo itself into the folder.
mkdir -p RaspberryBean
rsync -av --progress \
      /home/bean/bean/  RaspberryBean/

# ğŸ€ Delete the originals ONLY when you have verified the copy.
rm -r /home/bean/bean/

# ğŸ€ Push to GitHub.
git add RaspberryBean
git status
git commit -m "Added RaspberryBean"
git push -u origin main

# ğŸ€ğŸ€ ---------- Working with GitHub ---------- ğŸ€ğŸ€

# ğŸ€ Pull changes from GitHub to the Pi (only if there are no un-pushed commits; safer).
cd ~/Bean
git pull --ff-only

# ğŸ€ Pull changes from GitHub to the Pi (discards local edits and matches GitHub exactly).
cd ~/Bean
git fetch origin main && git reset --hard origin/main

# ğŸ€ Push changes from the Pi to GitHub.
cd ~/Bean
git add -A
git commit -m "Pushed from RaspberryBean"
git push

# ğŸ€ Copy changes from a file on the Pi to a file in the repo (e.g. the config file). Put the path to the source file first, and target file after.
cp -f /boot/firmware/config.txt /home/bean/Bean/RaspberryBean/config.txt